!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@tiptap/core"),require("@tiptap/pm/state"),require("@tiptap/pm/view"),require("katex")):"function"==typeof define&&define.amd?define(["exports","@tiptap/core","@tiptap/pm/state","@tiptap/pm/view","katex"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@tiptap-pro/extension-mathematics"]={},e.core,e.state,e.view,e.katex)}(this,(function(e,t,i,o,n){"use strict";function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=a(n);const s=e=>{const{regex:n,katexOptions:a={},editor:s,shouldRender:r}=e;return new i.Plugin({key:new i.PluginKey("mathematics"),state:{init:()=>({decorations:void 0,isEditable:void 0}),apply(e,i,c,p){if(!e.docChanged&&!e.selectionSet&&i.decorations)return i;const l=(i.decorations||o.DecorationSet.empty).map(e.mapping,e.doc),{selection:m}=p,f=s.isEditable,h=[],{minFrom:u,maxTo:g}=function(e,i,o,n,a){const d=e.doc.nodeSize-2;let s=0,r=d;if(i.isEditable!==o)s=0,r=d;else if(n.docChanged)s=d,r=0,t.getChangedRanges(n).forEach((e=>{s=Math.min(s,e.newRange.from-1,e.oldRange.from-1),r=Math.max(r,e.newRange.to+1,e.oldRange.to+1)}));else if(n.selectionSet){const{$from:t,$to:i}=a.selection,{$from:o,$to:n}=e.selection;s=Math.min(0===t.depth?0:t.before(),0===o.depth?0:o.before()),r=Math.max(0===i.depth?r:i.after(),0===n.depth?r:n.after())}return{minFrom:Math.max(s,0),maxTo:Math.min(r,d)}}(p,i,f,e,c);p.doc.nodesBetween(u,g,((e,t)=>{const i=r(p,t,e);if(e.isText&&e.text&&i){let i;for(;i=n.exec(e.text);){const e=t+i.index,n=e+i[0].length,s=i.slice(1).find(Boolean);if(s){const t=m.from-m.to,i=m.anchor>=e&&m.anchor<=n,r=m.from>=e&&m.to<=n,c=0===t&&i||r;if(l.find(e,n,(e=>c===e.isEditing&&s===e.content&&f===e.isEditable&&a===e.katexOptions)).length)continue;h.push(o.Decoration.inline(e,n,{class:c&&f?"Tiptap-mathematics-editor":"Tiptap-mathematics-editor Tiptap-mathematics-editor--hidden",style:c&&f?void 0:"display: inline-block; height: 0; opacity: 0; overflow: hidden; position: absolute; width: 0;"},{content:s,isEditable:f,isEditing:c,katexOptions:a})),f&&c||h.push(o.Decoration.widget(e,(()=>{const e=document.createElement("span");e.classList.add("Tiptap-mathematics-render"),f&&e.classList.add("Tiptap-mathematics-render--editable");try{d.default.render(s,e,a)}catch(t){e.innerHTML=s}return e}),{content:s,isEditable:f,isEditing:c,katexOptions:a}))}}}}));const x=h.flatMap((e=>l.find(e.from,e.to)));return{decorations:l.remove(x).add(e.doc,h),isEditable:f}}},props:{decorations(e){var t,i;return null!==(i=null===(t=this.getState(e))||void 0===t?void 0:t.decorations)&&void 0!==i?i:o.DecorationSet.empty}}})},r=(e,t)=>!("codeBlock"===e.doc.resolve(t).parent.type.name),c=t.Extension.create({name:"Mathematics",addOptions:()=>({regex:/\$([^\$]*)\$/gi,katexOptions:void 0,shouldRender:r}),addProseMirrorPlugins(){return[s({...this.options,editor:this.editor})]}});e.Mathematics=c,e.MathematicsPlugin=s,e.default=c,e.defaultShouldRender=r,Object.defineProperty(e,"__esModule",{value:!0})}));
