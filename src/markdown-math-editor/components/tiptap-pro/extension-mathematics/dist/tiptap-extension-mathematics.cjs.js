"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@tiptap/core"),t=require("@tiptap/pm/state"),i=require("@tiptap/pm/view");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=o(require("katex"));const a=o=>{const{regex:a,katexOptions:r={},editor:s,shouldRender:d}=o;return new t.Plugin({key:new t.PluginKey("mathematics"),state:{init:()=>({decorations:void 0,isEditable:void 0}),apply(t,o,c,l){if(!t.docChanged&&!t.selectionSet&&o.decorations)return o;const p=(o.decorations||i.DecorationSet.empty).map(t.mapping,t.doc),{selection:m}=l,h=s.isEditable,u=[],{minFrom:f,maxTo:g}=function(t,i,o,n,a){const r=t.doc.nodeSize-2;let s=0,d=r;if(i.isEditable!==o)s=0,d=r;else if(n.docChanged)s=r,d=0,e.getChangedRanges(n).forEach((e=>{s=Math.min(s,e.newRange.from-1,e.oldRange.from-1),d=Math.max(d,e.newRange.to+1,e.oldRange.to+1)}));else if(n.selectionSet){const{$from:e,$to:i}=a.selection,{$from:o,$to:n}=t.selection;s=Math.min(0===e.depth?0:e.before(),0===o.depth?0:o.before()),d=Math.max(0===i.depth?d:i.after(),0===n.depth?d:n.after())}return{minFrom:Math.max(s,0),maxTo:Math.min(d,r)}}(l,o,h,t,c);l.doc.nodesBetween(f,g,((e,t)=>{const o=d(l,t,e);if(e.isText&&e.text&&o){let o;for(;o=a.exec(e.text);){const e=t+o.index,a=e+o[0].length,s=o.slice(1).find(Boolean);if(s){const t=m.from-m.to,o=m.anchor>=e&&m.anchor<=a,d=m.from>=e&&m.to<=a,c=0===t&&o||d;if(p.find(e,a,(e=>c===e.isEditing&&s===e.content&&h===e.isEditable&&r===e.katexOptions)).length)continue;u.push(i.Decoration.inline(e,a,{class:c&&h?"Tiptap-mathematics-editor":"Tiptap-mathematics-editor Tiptap-mathematics-editor--hidden",style:c&&h?void 0:"display: inline-block; height: 0; opacity: 0; overflow: hidden; position: absolute; width: 0;"},{content:s,isEditable:h,isEditing:c,katexOptions:r})),h&&c||u.push(i.Decoration.widget(e,(()=>{const e=document.createElement("span");e.classList.add("Tiptap-mathematics-render"),h&&e.classList.add("Tiptap-mathematics-render--editable");try{n.default.render(s,e,r)}catch(t){e.innerHTML=s}return e}),{content:s,isEditable:h,isEditing:c,katexOptions:r}))}}}}));const x=u.flatMap((e=>p.find(e.from,e.to)));return{decorations:p.remove(x).add(t.doc,u),isEditable:h}}},props:{decorations(e){var t,o;return null!==(o=null===(t=this.getState(e))||void 0===t?void 0:t.decorations)&&void 0!==o?o:i.DecorationSet.empty}}})},r=(e,t)=>!("codeBlock"===e.doc.resolve(t).parent.type.name),s=e.Extension.create({name:"Mathematics",addOptions:()=>({regex:/\$([^\$]*)\$/gi,katexOptions:void 0,shouldRender:r}),addProseMirrorPlugins(){return[a({...this.options,editor:this.editor})]}});exports.Mathematics=s,exports.MathematicsPlugin=a,exports.default=s,exports.defaultShouldRender=r;
